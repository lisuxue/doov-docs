<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>How to Share the Business Logic in a Polyglot App Mixing Java and TypeScript - Code One 2019 [BOF3570]</title>
  <meta name="description" content="dOOv is fluent, stream-like API, great for writing type checked code, taking advantage of Java 8 functions and lambdas. In this presentation we will explore the issues of the predicate reduction features of dOOv.">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="bower_components/reveal.js/css/reveal.css">
  <link rel="stylesheet" href="bower_components/reveal.js/lib/css/zenburn.css">
  <link rel="stylesheet" href="css/ocode-theme.css" id="theme">
  <style>
      body {
        background-color: #034a5e;
        background-image: linear-gradient(to bottom right,#0d718d, #515d7f, #b23743, rgba(237, 31, 120, 0.58));
        background-image: -webkit-linear-gradient(to bottom right,#0d718d, #515d7f, #b23743, rgba(237, 31, 120, 0.58));
      }
  </style>
  <script>
    if (window.location.search.match(/print-pdf/gi)) {
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = 'css/print/pdf.css';
      document.getElementsByTagName('head')[0].appendChild(link);
    }
  </script>
</head>

<body>
  <div class="footer">
    <img class="logo-lesfurets" src="img/Les Furets_Logo_Darkbackgound_RGB.svg">
    <img class="logo-lesfurets" src="img/doov_io_logo_clear_small.png">
    <img class="logo-conference" src="img/oco19-logo_ping.png">
  </div>
  <div class="reveal">
    <div class="slides">

        <section>
            <img class="logo herve-francois" width="45%" src="img/lf_com_herve_francois.png">
            <div class="container-grid-3">
                <h1 class="code">How to Share the Business Logic
                    <br>in a Polyglot App
                    <br>Mixing Java and TypeScript
                </h1>
            </div>
        </section>

        <section>
            <section>
                <h2>Welcome to the Furets!</h2>
            </section>
            <section>
                <div class="">
                    <h2>@ozangunalp – Ozan Gunalp</h2>
                    <ul>
                        <li>PhD in Computer Science, Java, OSGi, IoT, CI/CD</li>
                        <li>JenkinsPipelineUnit</li>
                        <li>Software Architect at LesFurets.com</li>
                    </ul>
                </div>
                <br>
                <br>
                <div class="">
                    <h2>@gdigugli – Gilles Di Guglielmo</h2>
                    <ul>
                        <li>Designer of sweet cooked software since 1999</li>
                        <li>Software Architect at LesFurets.com</li>
                    </ul>
                </div>
            </section>
            <section>
                <img width="50%" src="img/logo_lesfurets_new.png">
                <p></p>
                <ul class="">
                    <li>5 Insurance Products : Car, Health, Home, Bike, Loan</li>
                    <li>Other Comparison Products : Energy, Credit, ISP, ...</li>
                    <li class="emptyline">1 codebase, 500k lines of code, 60k unit tests, 150 selenium tests</li>

                    <li>25+ Developers, 2 DevOps, 3 Architects</li>
                    <li class="emptyline">30+ production servers including Load balancers, Frontend, Backend, Databases,
                        BI
                    </li>

                    <li>Daily release to production</li>
                    <li class="emptyline">10+ years of code history
                        <br/>
                    </li>

                    <li>3M quotes/year, 40% of market share, 4M of customers</li>
                </ul>
            </section>
        </section>

        <section>
            <section>
                <h2>Introduction</h2>
            </section>

            <section data-transition="slide-in fade-out">
                <img width="66%" src="img/lf_car_journey.png">
            </section>

            <section data-transition="fade">
                <img width="66%" src="img/lf_com_car_price_sheet.png">
            </section>

            <section data-transition="fade">
                <h2>LesFurets service orchestration</h2>
                <img width="80%" src="img/lf_scatter_gather.png">
            </section>

            <section data-transition="fade-in slide-out">
                <h2>LesFurets service orchestration</h2>
                <img width="80%" src="img/lf_scatter_gather_business_rules.png">
            </section>

            <section>
                <h2>Insurers partners</h2>
                <p>We have 100 live insurers, on 5 products, each with
                    <strong>business validation rules</strong>, that filter prospects based on their profile</p>
            </section>

            <section>
                <h2>Insurer exclusions</h2>
                <p>Hierarchy of 492 legacy classes, no governance or auditability</p>
                <img width="40%" src="img/exclusion-list.png">
            </section>

            <section>
                <h2>Use case: insurer exclusions</h2>
                <p>Insurer exclusions based on object model (legacy code)</p>
                <div class="code-wrapper small">
            <pre class="prettyprint">
                <code class="code lang-java">
public void check(FieldContext context, FormuleMoto formule, Conducteur conducteur,
                  Vehicule vehicule, Void unused, Besoins besoins,
                  Set&lt;EAbTestingScenario&gt; scenarios)
                  throws ExclusionException {
    if (besoins == null) {
        return;
    }
    if (besoins.getDateDebutContrat() == null) {
        return;
    }
    if (!DateHelper.isAfter(besoins.getDateDebutContrat(),
                    DateHelper.ajouteJoursADate(DateHelper.getToday(), NBR_JOURS),
                    DateHelper.EPrecision.jour)) {
        throw new ExclusionException(DATE_EFFET_PLUS_60_JOURS);
    }
}
                </code>
              </pre>
                </div>
            </section>

            <section>
                <h2>Use case: goal</h2>
                <ul>
                    <li>
                        <strong>compliance</strong>: the rules correspond to the specification documents
                    </li>
                    <li>
                        <strong>auditability</strong>: understand a rule without looking at the code
                    </li>
                    <li>
                        <strong>governance</strong>: maintenance of the rules catalogue
                    </li>
                    <li>
                        <strong>clarity</strong>: productivity for developers
                    </li>
                </ul>
                <p>Same rule, more
                    <strong>fluent</strong>:</p>
                <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
public ExclusionRule exclusionRule() {
    return DOOV.when(dateContrat().after(todayPlusDays(60)))
               .exclusionRule();
}
                </code>
              </pre>
                </div>
            </section>

            <section>
                <h2>Meet dOOv!</h2>
                <p>
                    <strong>D</strong>omain
                    <strong>O</strong>bject
                    <strong>O</strong>riented
                    <strong>V</strong>alidation</p>
                <img class="logo herve-francois" src="img/doov_io_logo_dark_large.png" width="40%">
                <p><strong>a fluent API for typesafe domain model validation</strong></p>
            </section>
        </section>
        <section>
            <section>
                <p>
                    <strong>dOOv</strong> : Under the hood</p>
                <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">DOOV.when(accountCompany.eq(Company.LES_FURETS)
            .and(accountPhoneNumber.startsWith("+33"))).validate();</code>
              </pre>
                </div>
                <br/>
                <img src="img/metadata_lambda_tree.svg" width="90%">
            </section>
            <section>
                <h2>DEMO</h2>
            </section>
            <section>
                <h2>Export to text, markdown,...</h2>
                <div class="code-wrapper small">
            <pre class="prettyprint">
                <code class="code lang-java">DOOV.when(accountCompany.eq(Company.LES_FURETS)
            .and(accountPhoneNumber.startsWith("+33"))).validate();</code>
              </pre>
                </div>
                <p><strong>Markdown</strong></p>
                <div class="code-wrapper small">
            <pre class="prettyprint">
                <code class="code lang-xml output">
* rule
  * when
    * account company = 'LES_FURETS' and
    * account phone number starts with &apos;+33&apos;
  * validate
                </code>
              </pre>
                </div>
                <p><strong>Text</strong></p>
                <div class="code-wrapper small">
            <pre class="prettyprint">
                <code class="code lang-xml output">
rule when (account company = LES_FURETS and account phone number starts with '+33') validate
                </code>
              </pre>
                </div>

            </section>
            <section>
                <h2>Runtime Rule Catalog & Business Oriented statistics</h2>
                <img src="img/exclusions_maintenance_page.png" width="80%">
            </section>
        </section>

        <section>
            <section data-transition="fade-in slide-out">
                <h2>LesFurets service Mapping</h2>
                <img width="80%" src="img/lf_scatter_gather_mapping_rules.png">
            </section>

            <section>
                <h2>Domain Object Oriented Mapping</h2>
                <p>Next step is extending the DSL to create a<br>
                    <strong>bean mapping framework</strong>
                <p>It features the same AST to text and statistics functionalities.</p>
            </section>

            <section>
                <h2>Use Case : Object-to-Object Mapping</h2>
                <div class="horizontal">
                    <div class="column">
                        <p>
                            <strong style="color:orange">source model</strong>
                        </p>
                        <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-java">
class Model {
  User user;
  Account account;
}

class User {
  String firstName;
  String lastName;
  LocalDate birthdate;
}

class Account {
  String email;
  boolean acceptEmail;
  Country country;
}
                    </code>
                  </pre>
                        </div>
                    </div>
                    <div class="column fragment">
                        <p>→</p>
                    </div>
                    <div class="column fragment">
                        <p class="in-model">
                            <strong style="color:#59B2AC">target model</strong>
                        </p>
                        <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-java">
class Employee {
  String fullName;
  String email;
  int age;
  String country;
  String company;
}
                    </code>
                  </pre>
                        </div>
                    </div>
                </div>
            </section>


            <section>
                <h2>Use Case : Object-to-Object Mapping</h2>
                <div class="code-wrapper">
                  <pre class="prettyprint">
                      <code class="code lang-java">Model model = ...;
Employee employee = new Employee();
<span class="fragment">// declarative mapping rule
MappingRule rules = mappings(
  <span class="fragment">when(<mark class="in-model">accountAcceptEmail</mark>.isTrue())
      .then(map(<mark class="in-model">accountEmail</mark>).to(<mark class="out-model">employeeEmail</mark>)),</span>

  <span class="fragment">map(<mark class="in-model">userFirstName</mark>, <mark class="in-model">userLastName</mark>)
      .using(biConverter((f, l) -> f + " " + l, "", "combine names"))
      .to(<mark class="out-model">employeeFullname</mark>),</span>

  <span class="fragment">map(<mark class="in-model">userBirthdate</mark>.ageAt(today())).to(<mark class="out-model">employeeAge</mark>),</span>

  <span class="fragment">map(<mark class="in-model">accountCountry</mark>)
      .using(converter(c -> c.name(), "country name"))
      .to(<mark class="out-model">employeeCountry</mark>)</span>
);</span>
<span class="fragment">// then execute the mapping
rules.executeOn(model, employee)</span>
                    </code>
                </pre>
                </div>
            </section>
            <section data-transition="fade">
                <h2>Use Case : Object-to-Object Mapping</h2>
                <div class="horizontal">
                    <div class="column column-2">
                        <div class="code-wrapper smaller">
                  <pre class="prettyprint">
                      <code class="code lang-java">Model model = ...;
Employee employee = new Employee();
// declarative mapping rule
MappingRule rules = mappings(
  when(<mark class="in-model">accountAcceptEmail</mark>.isTrue())
      .then(map(<mark class="in-model">accountEmail</mark>).to(<mark class="out-model">employeeEmail</mark>)),

  map(<mark class="in-model">userFirstName</mark>, <mark class="in-model">userLastName</mark>)
      .using(biConverter(
            (f, l) -> f + " " + l, "", "combine names"))
      .to(<mark class="out-model">employeeFullname</mark>),

  map(<mark class="in-model">userBirthdate</mark>.ageAt(today())).to(<mark class="out-model">employeeAge</mark>),

  map(<mark class="in-model">accountCountry</mark>)
      .using(converter(c -> c.name(), "country name"))
      .to(<mark class="out-model">employeeCountry</mark>)
);
// then execute the mapping
rules.executeOn(model, employee)</code>
                </pre>
                        </div>
                    </div>
                    <div class="column column-2" style="width: 800px; height: auto;">
                        <img width="80%" src="img/mapping_html_en.png">
                    </div>
                </div>
            </section>
        </section>

        <section>
            <section data-transition="fade-in slide-out">
                <h2>LesFurets Frontend Rules</h2>
                <img width="80%" src="img/lf_front_rules.png">
            </section>

            <section data-transition="fade-in slide-out">
                <h2>LesFurets Web Form</h2>
                <img width="66%" src="img/lf_car_journey.png">
            </section>

            <section data-transition="fade-in slide-out">
                <h2>Web Form Rules</h2>
                <div>
                    <img width="66%" data-background-color="white" src="img/doov_ui_bootstrap.png">
                </div>
            </section>

            <section data-transition="fade">
                <h2>Initial values, options</h2>
                <div class="container-grid-2">
                    <div>
                        <img width="100%" data-background-color="white" src="img/doov_ui_crust_values.png">
                    </div>
                    <div class="small v-centered">
                <pre class="prettyprint">
                    <code class="code lang-javascript">
map(['Napolitan', 'New York',
     'StLouis', 'Pan',
     'DeepDish', 'Sicilian'])
  .to(crustOptions);
                    </code>
                  </pre>
                    </div>
                </div>
            </section>

            <section data-transition="fade">
                <h2>Update store with value change</h2>
                <div class="container-grid-2">
                    <div>
                        <img width="100%" data-background-color="white" src="img/doov_ui_select_location.png">
                    </div>
                    <div class="small v-centered">
                <pre class="prettyprint">
                    <code class="code lang-javascript">
map(fieldValue).to(city),

when(city.eq('napoli'))
.then(
  map(['Napolitan'])
    .to(crustOptions)
)
                    </code>
                  </pre>
                    </div>
                </div>
            </section>

            <section data-transition="fade">
                <h2>Update field from store: value, options, visibility</h2>
                <div class="container-grid-2">
                    <div>
                        <img width="100%" data-background-color="white" src="img/doov_ui_update_values.png">
                    </div>
                    <div class="small v-centered">
                <pre class="prettyprint">
                    <code class="code lang-javascript">
when(city.eq('napoli'))
.then(
  map('L').to(size)
)

map(size).to(fieldValue)
                    </code>
                  </pre>
                    </div>
                </div>
            </section>

            <section data-transition="fade-in slide-out">
                <h2>Validate field value</h2>
                <div class="container-grid-2">
                    <div>
                        <img width="100%" data-background-color="white" src="img/doov_ui_validation.png">
                    </div>
                    <div class="small v-centered">
                <pre class="prettyprint">
                    <code class="code lang-javascript">
when(
  matchAll(
    city.eq('napoli'),
    crust.notEq('Pan')
  )).validate()
                    </code>
                  </pre>
                    </div>
                </div>
            </section>

            <section>
                <h2>Frontend Rules @ LesFurets</h2>
                <p><strong>1000 fields</strong> with more than <strong>3100 form interaction rules</strong></br> spanned over <strong>600 classes</strong></p>
                </p>No <strong>governance</strong> or <strong>auditability</strong></p>
            </section>

            <section data-transition="fade-in slide-out">
                <h2>Meet doov-TS</h2>
                <img class="logo herve-francois" src="img/doov_io_logo_dark_large.png" width="40%">
                <p><strong>dOOv in TypeScript</strong></p>
                <a href="https://github.com/doov-io/doov-ts">https://github.com/doov-io/doov-ts</a>
            </section>

        </section>
        <section>
            <section>
                <h2>Why TypeScript?</h2>
            </section>
            <section data-transition="fade">
                <h2>Superset of JS syntax with ESNext features</h2>
                <p><strong>const & let</strong></p>
                <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-javascript">
const name: string = 'Bob';
let age: number = 26;
i++;
name = 'Alice';
// TS2588: Cannot assign to 'name' because it is a constant.
                    </code>
                  </pre>
                </div>
            </section>
            <section data-transition="fade">
                <h2>Superset of JS syntax with ESNext features</h2>
                <p><strong>Arrow functions</strong></p>
                <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-javascript">
const reverse = (v: string) => {
  return v.split().reverse().join('');
}
                    </code>
                  </pre>
                </div>
            </section>
            <section data-transition="fade">
                <h2>Superset of JS syntax with ESNext features</h2>
                <p><strong>Classes, static methods, access modifiers</strong></p>
                <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-javascript">
class Square extends Rectangle {
  readonly colour: string;

  constructor(a: number, colour: string) {
    super(a, a);
    this.colour = colour;
  }

  public static area(r: Rectangle) {
    return r.a * r.b;
  }
}</code>
                  </pre>
                </div>
            </section>
            <section data-transition="fade">
                <h2>Superset of JS syntax with ESNext features</h2>
                <p><strong>Promises</strong></p>
                <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-javascript">
import fs from 'fs';

function readFileAsync(filename: string): Promise&lt;Buffer&gt; {
  return new Promise((resolve, reject) => {
    fs.readFile(filename, (err, result) => {
      err ? reject(err) : resolve(result);
    });
  });
}</code>
                  </pre>
                </div>
            </section>
            <section>
                <h2>Optional strong type system</h2>
                <p><strong>Interface, Generics, Type Union & Intersection, Type Guards...</strong></p>
                <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-javascript">
interface Square { kind: "square"; size: number; }

interface Rectangle { kind: "rectangle"; width: number; height: number; }

type Shape = Square | Rectangle

function area(s: Shape) {
    return s.kind === "square" ? s.size * s.size : s.width * s.height;
}
                    </code>
                  </pre>
                </div>
            </section>
                <section>
                    <h2>Compiles to JS</h2>
                <div class="horizontal">
                    <div class="column">
                        <p>
                            <strong style="color:deepskyblue">TS</strong>
                        </p>
                        <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-javascript">
const num: number = 123;

interface WithStr {
  num: number;
  str: string;
}

function attachStr(num: number): WithStr {
  return { num: num, str: String(num) };
}
                    </code>
                  </pre>
                        </div>
                    </div>
                    <div class="column">
                        <p>→</p>
                    </div>
                    <div class="column">
                        <p class="in-model">
                            <strong style="color:yellow">JS</strong>
                        </p>
                        <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-javascript">
var num = 123;
function attachStr(num) {
    return { num: num, str: String(num) };
}
                    </code>
                  </pre>
                        </div>
                    </div>
                </div>
            </section>
            <section>
                <h2>Why TypeScript?</h2>
                <p><strong>Types are necessary to scale a JS app</strong></p>
                <p><strong>Hides away questions about ES language level and target environment into compiler configuration</strong></p>
                <p><strong>TypeScript syntax is very similar to Java</br>(except for the right-hand side type annotations)</strong></p>
            </section>
        </section>

        <section>
            <h2>DEMO doov-TS</h2>
        </section>

        <section>
            <h2>Migrating business rules to dOOv</h2>
                <p><strong>Business rules are easier to code, grasp and govern</strong>
                </p>
                <p><strong>Debugging is not obvious</strong>
                </br><strong>Code coverage is misleading</strong></p>
        </section>

        <section>
          <h2>Enjoy dOOv.io</h2>
          <img class="logo herve-francois" src="img/doov_io_logo_dark_large.png" width="20%">
            <p style="padding: 10px"><a href="http://www.dOOv.io">http://www.dOOv.io</a></p>
            <p style="padding: 10px"><strong>dOOv & dOOv-TS (framework and examples)</strong></br><a href="http://github.com/doov-io/doov">http://github.com/doov-io</a></p>
            <p style="padding: 10px"><strong>dOOv-TS Example</strong></br><a href="https://codesandbox.io/s/github/ozangunalp/doov-ts-example">https://codesandbox.io/s/github/ozangunalp/doov-ts-example</a></p>
            <p style="padding: 10px"><strong>Slides</strong></br><a href="http://github.com/doov-io/doov-docs">http://github.com/doov-io/doov-docs</a></p>
            <p style="padding: 10px">Open Source & Apache Licence</p>
            <p style="padding: 10px">Try and contribute!</p>
        </section>

      </section>

      </section>

      <section>
        <section>
          <h2>Appendices</h2>
        </section>

        <section>
          <h2>DSL</h2>
          <p>
            <em>"A domain-specific language (DSL) is a computer language specialized to a particular application domain. This
              is in contrast to a general-purpose language (GPL), which is broadly applicable across domains"</em>
          </p>
        </section>

        <section>
          <h2>dOOv ecosystem</h2>
          <img class="logo herve-francois" src="img/doov_ecosystem.svg" width="75%">
        </section>

        <section>
          <h2>How to write a validation rule?</h2>
          <div class="horizontal">
            <div class="column">
              <p>
                <strong>key model</strong>
              </p>
              <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-java">
// Root class of model
class Model {
  User user;
}

// Add key named EMAIL
enum ModelFieldId {
  <mark class="fragment">EMAIL</mark>;
}

// Annotate email field
class User {
  @Path(field = <mark class="fragment">EMAIL</mark>
        readable = <mark class="fragment true-predicate">...</mark>)
  String email;
}
                    </code>
                  </pre>
              </div>
            </div>
            <div class="column fragment">
              <p>
                <strong>code generate</strong>
              </p>
              <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-java">
// dOOv typed field class
class DslModel {
  StringFieldInfo <mark class="fragment true-predicate">userEmail</mark>;
}
                    </code>
                  </pre>
              </div>
            </div>
            <div class="column fragment">
              <p>
                <strong>write rules</strong>
              </p>
              <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-java">
// Create rules by using
// generated fields
// in DslModel
DslModel
  .when(<mark class="fragment true-predicate">userEmail</mark>.eq(...))
  .validate()
  // Optionaly add rules
  // to a registry
  .registerOn(DEFAULT);
                    </code>
                  </pre>
              </div>
            </div>
          </div>
        </section>

        <section>
          <h2>How to validate a model</h2>
          <div class="horizontal">
            <div class="column">
              <p>
                <strong>get model</strong>
              </p>
              <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-java">
// Get model from somewhere
// or instanciate it
User user = new User();
user.setEmail("e@mail.com");

Model <mark class="fragment">model</mark> = new Model();
model.setUser(user);
                    </code>
                  </pre>
              </div>
            </div>
            <div class="column fragment">
              <p>
                <strong>execute</strong>
              </p>
              <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-java">
// Use executeOn method
DslModel.when(email.matches(...))
        .validate()
        .executeOn(<mark class="fragment">model</mark>);

// Or use the registry
DEFAULT.stream()
  .map(rule -&gt; rule.executeOn(<mark class="fragment">model</mark>));
                    </code>
                  </pre>
              </div>
            </div>
          </div>
        </section>

        <section>
          <h2>Why a fluent API?</h2>
          <p>Java is verbose, but you can reduce the noise and write code like natural language with a fluent API</p>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
// JUnit API
assertEquals(9, fellowshipOfTheRing.size());
assertTrue(fellowshipOfTheRing.contains(frodo, sam));
assertFalse(fellowshipOfTheRing.contains(sauron));

// AssertJ API (fluent)
assertThat(fellowshipOfTheRing).hasSize(9)
                               .contains(frodo, sam)
                               .doesNotContain(sauron);
                </code>
              </pre>
          </div>
        </section>

        <section>
          <h2>Fluent API</h2>
          <p>New elements in Java 8 makes it easier to write a fluent API</p>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
// java.util.function (io.doov.core.dsl.impl.LogicalBinaryCondition)
left.predicate().and(right.predicate()).test(model, context)

// java.util.stream (io.doov.core.dsl.impl.LogicalNaryCondition)
steps.stream().anyMatch(s -&gt; s.predicate().test(model, context))

// lambda and method reference (io.doov.core.dsl.impl.NumericCondition)
predicate(greaterThanMetadata(field, value),
          (model, context) -&gt; Optional.ofNullable(value),
          (l, r) -&gt; greaterThanFunction().apply(l, r));
                </code>
              </pre>
          </div>
        </section>

        <section>
          <h2>Fluent API</h2>
          <p>Many popular libraries propose fluent APIs like
            <br>
            <strong>jOOQ</strong>,
            <strong>AssertJ</strong>,
            <strong>Apache Spark</strong>, etc.</p>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
Dataset&lt;Row&gt; averagePrice = prices
        .filter(value.&lt;String&gt;getAs("insurer")
                     .equals("COOL insurer"))
        .groupBy("product")
        .agg(avg("price").as("average"))
        .orderBy(desc("average"));
                </code>
              </pre>
          </div>
        </section>

        <section>
          <h2>Syntax tree</h2>
          <img src="dot/ast.svg" width="35%">
        </section>

        <section>
          <h2>Why a syntax tree?</h2>
          <p>Makes readable text generation possible:
          <br/>we can output a multi-language rules catalog
          <br/>in multiple formats (text, markdown, HTML, etc.)</p>
          <img src="img/doov_rules_visitor_test.png" width="90%">
        </section>

        <section>
          <h2>Execution statistics</h2>
          <p>We make daily statistics that helps us shape the business,
          <br/>by removing or tweaking rules as needed</p>
          <img src="img/doov_failure_cause.png" width="90%">
        </section>

        <section>
            <h2>Combined 'and' & 'or' operators</h2>
            <p>
              <em>Validate that a profile
                <br> has at least 18 years when their country is France
                <br> and their phone number starts with '+33'
                <br> has at least 21 years when their country is Canadian
                <br> and their phone number starts with '+1'</em>
            </p>
            <p/>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                      <code class="code lang-java">
    DOOV.when(userBirthdate.ageAt(today()).greaterThan(18)
            .and(accountCountry.eq(Country.FR)
            .and(accountPhoneNumber.startsWith("+33")))
            .or(userBirthdate.ageAt(today()).greaterThan(21)
                  .and(accountCountry.eq(Country.CAN)
                  .and(accountPhoneNumber.startsWith("+1")))))
        .validate();
                      </code>
                    </pre>
            </div>
          </section>

          <section>
            <h2>Combined 'and' & 'or' operators</h2>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                    <code class="code lang-java">
    model.getUser().setBirthDate(LocalDate.now().minusYears(22));
    model.getAccount().setCountry(Country.FR);
    
    ValidationRule rule = DOOV
        .when(<mark class="true-predicate">userBirthdate.ageAt(today()).greaterThan(18)</mark>
            .and(<mark class="true-predicate">accountCountry.eq(Country.FR)</mark>
            .and(<mark class="false-predicate">accountPhoneNumber.startsWith("+33")</mark>))
            .or(<mark class="true-predicate">userBirthdate.ageAt(today()).greaterThan(21)</mark>
                  .and(<mark class="false-predicate">accountCountry.eq(Country.CAN)</mark>
                  .and(<mark class="false-predicate">accountPhoneNumber.startsWith("+1")</mark>))))
        .validate();
    
    Result result = rule.withShortCircuit(false).executeOn(wrapper);
    System.out.println("&gt; " + result.getFailureCause());
                    </code>
                  </pre>
            </div>
            <br>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                    <code class="code lang-xml output">
    &gt; account phone number starts with '+33'
        or (account country = CAN and
            account phone number starts with '+1')
                    </code>
                  </pre>
            </div>
          </section>
          <section>
            <h2>Combined 'matchAll' & 'matchAny' operators</h2>
            <p>
              <em>Validate that a profile
                <br> has at least 18 years when their country is France
                <br> and their phone number starts with '+33'
                <br> has at least 21 years when their country is Canadian
                <br> and their phone number starts with '+1'</em>
            </p>
            <p/>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                      <code class="code lang-java">
    DOOV.when(matchAny(
            matchAll(userBirthdate.ageAt(today()).greaterThan(18),
                     accountCountry.eq(Country.FR),
                     accountPhoneNumber.startsWith("+33")),
            matchAll(userBirthdate.ageAt(today()).greaterThan(21),
                     accountCountry.eq(Country.CAN),
                     accountPhoneNumber.startsWith("+1"))))
         .validate();
                     </code>
                    </pre>
            </div>
          </section>

          <section>
            <h2>Combined 'matchAll' & 'matchAny' operators</h2>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                    <code class="code lang-java">
    model.getUser().setBirthDate(LocalDate.now().minusYears(22));
    model.getAccount().setCountry(Country.FR);
    
    ValidationRule rule = DOOV
        .when(matchAny(
            matchAll(<mark class="true-predicate">userBirthdate.ageAt(today()).greaterThan(18)</mark>,
                     <mark class="true-predicate">accountCountry.eq(Country.FR)</mark>,
                     <mark class="false-predicate">accountPhoneNumber.startsWith("+33")</mark>),
            matchAll(<mark class="true-predicate">userBirthdate.ageAt(today()).greaterThan(21)</mark>,
                     <mark class="false-predicate">accountCountry.eq(Country.CAN)</mark>,
                     <mark class="false-predicate">accountPhoneNumber.startsWith("+1")</mark>)))
        .validate();
    
    Result result = rule.withShortCircuit(false).executeOn(wrapper);
    System.out.println("&gt; " + result.getFailureCause());
                    </code>
                  </pre>
            </div>
            <br>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                    <code class="code lang-xml output">
    &gt; match any [account phone number starts with '+33',
                 match all [account country = CAN,
                            account phone number starts with '+1']]
                    </code>
                  </pre>
            </div>
          </section>

          <section>
            <h2>'anyMatch' operator for enumerated values</h2>
            <p>
              <em>Validate that a profile country is Canadian or French</em>
            </p>
            <p></p>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                    <code class="code lang-java">
    DOOV.when(accountCountry.anyMatch(Country.CAN, Country.FR)).validate();
                    </code>
                  </pre>
            </div>
          </section>

          <section>
            <h2>'anyMatch' operator for enumerated values</h2>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                    <code class="code lang-java">
    model.getAccount().setCountry(Country.UK);
    
    ValidationRule rule = DOOV
        .when(accountCountry.<mark class="false-predicate">anyMatch(Country.CAN, Country.FR)</mark>)
        .validate();
    
    Result result = rule.withShortCircuit(false).executeOn(wrapper);
    System.out.println("&gt; " + result.getFailureCause());
                    </code>
                  </pre>
            </div>
            <br>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                    <code class="code lang-xml output">
    &gt; account country != UK
                    </code>
                  </pre>
            </div>
          </section>

      </section>

      <section>

        <section>
          <h2>Appendices: rules design</h2>
        </section>

        <section>
          <h2>Going further : Implementing rules</h2>
          <div class="code-wrapper small">
            <pre class="prettyprint">
              <code class="code lang-java">
enum Company {
    BLABLACAR, CANAL_PLUS, DAILYMOTION,
    LES_FURETS, MEETIC, OODRIVE,
}
              </code>
            </pre>
          </div>
          <p>
            <em>Validate that the company of an account should
              <strong>NOT</strong> be
              <br> Dailymotion or Blablacar</em>
          </p>
          <div class="code-wrapper small">
            <pre class="prettyprint">
              <code class="code lang-java">
DOOV.when(accountCompany.noneMatch(DAILYMOTION, BLABLACAR)).validate();
              </code>
            </pre>
          </div>
        </section>

        <section>
          <h2>Implementing boolean logic</h2>
          <div class="code-wrapper">
            <pre class="prettyprint">
              <code class="code lang-java">
¬ DAILYMOTION ∧ ¬ BLABLACAR
// is equivalent to
¬ ( DAILYMOTION ∨ BLABLACAR )
// is equivalent to
LES_FURETS ∨ CANAL_PLUS ∨ MEETIC ∨ OODRIVE
              </code>
            </pre>
          </div>
          <br>
          <p>De Morgan's laws<br>
          https://en.wikipedia.org/wiki/De_Morgan's_laws<br>
          https://en.wikipedia.org/wiki/Conjunctive_normal_form</p>
        </section>

        <section>
          <p>
            Failure cause with <strong>noneMatch</strong>
          </p>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                <code class="code lang-java">
model.getAccount().setCompany(DAILYMOTION);

ValidationRule rule = DOOV
      .when(<mark class="false-predicate">accountCompany.noneMatch(DAILYMOTION, BLABLACAR)</mark>)
      .validate();
Result result = rule.withShortCircuit(false).executeOn(model);
System.out.println("&gt; " + result.getFailureCause());
                  </code>
                </pre>
          </div>
          <br>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                  <code class="code lang-xml output">
  &gt; account company match none  : DAILYMOTION, BLABLACAR
                  </code>
            </pre>
          </div>
        </section>

        <section>
          <p>
            Failure cause with <strong>notEq + and</strong>
          </p>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                <code class="code lang-java">
DOOV.when(<mark class="false-predicate">accountCompany.notEq(DAILYMOTION)</mark>
        .and(<mark class="true-predicate">accountCompany.notEq(BLABLACAR)</mark>)).validate();
            </code>
          </pre>
          </div>
          <br>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                    <code class="code lang-xml output">
  &gt; account company != DAILYMOTION
                    </code>
              </pre>
          </div>
          <p>Conjuctive Normal Form (CNF)</p>
        </section>

        <section>
          <p>
            Failure cause with <strong>not + or</strong>
          </p>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                  <code class="code lang-java">
DOOV.when(<mark class="true-predicate">accountCompany.eq(DAILYMOTION)</mark>
        .or(<mark class="false-predicate">accountCompany.eq(BLABLACAR)</mark>).not()).validate();
              </code>
            </pre>
          </div>
          <br>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                      <code class="code lang-xml output">
    &gt; not (account company = DAILYMOTION or account company = BLABLACAR)
                      </code>
                </pre>
          </div>
        </section>

        <section>
          <p>
            Failure cause with <strong>anyMatch</strong>
          </p>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                    <code class="code lang-java">
DOOV.when(<mark class="false-predicate">accountCompany.anyMatch(LES_FURETS, CANAL_PLUS, MEETIC, OODRIVE)</mark>)
        .validate();
                </code>
              </pre>
          </div>
          <br>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                <code class="code lang-xml output">
&gt; account company != DAILYMOTION
                </code>
              </pre>
          </div>
        </section>

        <section>
          <p>
            Failure cause with <strong>eq + or</strong>
          </p>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                      <code class="code lang-java">
DOOV.when(<mark class="false-predicate">accountCompany.eq(LES_FURETS)</mark>.or(<mark class="false-predicate">accountCompany.eq(CANAL_PLUS)</mark>
        .or(<mark class="false-predicate">accountCompany.eq(MEETIC)</mark>.or(<mark class="false-predicate">accountCompany.eq(OODRIVE)</mark>))))
                .validate();
                  </code>
                </pre>
          </div>
          <br>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                  <code class="code lang-xml output">
  &gt; account company = LES_FURETS or (account company = CANAL_PLUS 
         or (account company = MEETIC or account company = OODRIVE))
                  </code>
                </pre>
          </div>
        </section>

        <section>
          <h2>Speed is not enough</h2>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                  <code class="code lang-xml output">
Benchmark                                     Mode  Cnt     Score      Error   Units
<mark class="true-predicate"><strong>noneMatch</strong>                                     thrpt   20  8775.818 ± 148.951  ops/ms</mark>
<mark><strong>notEq + and</strong>  [failure cause OK]               thrpt   20  5022.391 ± 147.550  ops/ms</mark>
<strong>not + or</strong>                                      thrpt   20  3022.433 ± 586.881  ops/ms
<strong>anyMatch</strong>     [failure cause OK]               thrpt   20  6002.415 ±  94.531  ops/ms
<mark class="false-predicate"><strong>eq + or</strong>                                       thrpt   20  1855.837 ±  50.183  ops/ms</mark>
                  </code>
                </pre>
          </div>
          <br>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                    <code class="code lang-xml output">
Benchmark                                     Mode  Cnt     Score      Error   Units
<strong>noneMatch</strong>    with short circuit               thrpt   20  6839.429 ± 262.318  ops/ms
<mark class="true-predicate"><strong>notEq + and</strong>  with short circuit               thrpt   20  7397.586 ± 252.090  ops/ms</mark>
<strong>not + or</strong>     with short circuit               thrpt   20  5084.227 ± 450.013  ops/ms
<strong>anyMatch</strong>     with short circuit               thrpt   20  6275.185 ±  56.600  ops/ms
<mark class="false-predicate"><strong>eq + or</strong>      with short circuit               thrpt   20  1820.198 ±  60.300  ops/ms</mark>
                    </code>
                  </pre>
          </div>
          <br>
          <p>Writing rules in CNF provides the best performance and failure causes</p>
        </section>

      </section>

    </div>
  </div>
  <script src="bower_components/reveal.js/lib/js/head.min.js"></script>
  <script src="bower_components/reveal.js/js/reveal.js"></script>
  <script>
    // Full list of configuration options available here:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
      controls: false,
      progress: true,
      history: true,
      center: true,
      embedded: true,
      mouseWheel: true,
      viewDistance: 5,

      width: 1280,
      height: 900,
      margin: 0,

      transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none

      // Optional libraries used to extend on reveal.js
      dependencies: [
        { src: 'bower_components/reveal.js/lib/js/classList.js', condition: function () { return !document.body.classList; } },
        { src: 'bower_components/reveal.js/plugin/markdown/marked.js', condition: function () { return !!document.querySelector('[data-markdown]'); } },
        { src: 'bower_components/reveal.js/plugin/markdown/markdown.js', condition: function () { return !!document.querySelector('[data-markdown]'); } },
        //{ src: 'bower_components/reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
        { src: 'bower_components/reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function () { return !!document.body.classList; } },
        { src: 'bower_components/reveal.js/plugin/notes/notes.js', async: true, condition: function () { return !!document.body.classList; } }
      ]
    });

    // navigation with mouse click

    window.addEventListener("mousedown", handleClick, false);
    window.addEventListener("contextmenu", function (e) { e.preventDefault(); }, false);

    function handleClick(e) {
      e.preventDefault();
      if (e.button === 0) Reveal.next();
      if (e.button === 2) Reveal.prev();
    }

  </script>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
  <script src="js/doov.js"></script>
  <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?skin=desert&amp;callback=doov"></script>
</body>

</html>
